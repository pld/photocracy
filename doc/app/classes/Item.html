<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Item</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Item</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/models/item_rb.html">
                app/models/item.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                ActiveRecord::Base
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000147">activate</a>&nbsp;&nbsp;
      <a href="#M000156">by_win_percent</a>&nbsp;&nbsp;
      <a href="#M000151">for_question</a>&nbsp;&nbsp;
      <a href="#M000154">new_remote</a>&nbsp;&nbsp;
      <a href="#M000150">page_find</a>&nbsp;&nbsp;
      <a href="#M000163">pairwise_rank</a>&nbsp;&nbsp;
      <a href="#M000149">per_page</a>&nbsp;&nbsp;
      <a href="#M000148">plot</a>&nbsp;&nbsp;
      <a href="#M000145">position</a>&nbsp;&nbsp;
      <a href="#M000138">question</a>&nbsp;&nbsp;
      <a href="#M000139">ratings</a>&nbsp;&nbsp;
      <a href="#M000140">ratings_for_country</a>&nbsp;&nbsp;
      <a href="#M000158">ratings_for_country</a>&nbsp;&nbsp;
      <a href="#M000157">ratings_overall</a>&nbsp;&nbsp;
      <a href="#M000152">refresh_rank</a>&nbsp;&nbsp;
      <a href="#M000155">refresh_rank?</a>&nbsp;&nbsp;
      <a href="#M000146">suspend</a>&nbsp;&nbsp;
      <a href="#M000164">update_item_state</a>&nbsp;&nbsp;
      <a href="#M000153">valid_objects</a>&nbsp;&nbsp;
      <a href="#M000143">win_percent</a>&nbsp;&nbsp;
      <a href="#M000144">win_percent_for_country</a>&nbsp;&nbsp;
      <a href="#M000162">win_percents_overall</a>&nbsp;&nbsp;
      <a href="#M000161">win_percents_overall_array</a>&nbsp;&nbsp;
      <a href="#M000142">wins</a>&nbsp;&nbsp;
      <a href="#M000160">wins_for_country</a>&nbsp;&nbsp;
      <a href="#M000141">wins_for_country</a>&nbsp;&nbsp;
      <a href="#M000159">wins_overall</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="Constants/Item.html">Constants::Item</a></span>
      </div>
    </div>

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">agree</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000156" class="method-detail">
        <a name="M000156"></a>

        <div class="method-heading">
          <a href="#M000156" class="method-signature">
          <span class="method-name">by_win_percent</span><span class="method-args">(conditions)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000156-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000156-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 199</span>
199:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">by_win_percent</span>(<span class="ruby-identifier">conditions</span>)
200:       <span class="ruby-identifier">all</span>({ <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'(items_questions.wins/items_questions.ratings) desc'</span>,
201:         <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'items.id'</span>,
202:         <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'INNER JOIN items_questions ON items_questions.item_id=items.id'</span>
203:       }.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">conditions</span>))
204:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000151" class="method-detail">
        <a name="M000151"></a>

        <div class="method-heading">
          <a href="#M000151" class="method-signature">
          <span class="method-name">for_question</span><span class="method-args">(question, country_code, reject_under = REJECT_WITH_RATINGS_UNDER)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000151-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000151-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 129</span>
129:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">for_question</span>(<span class="ruby-identifier">question</span>, <span class="ruby-identifier">country_code</span>, <span class="ruby-identifier">reject_under</span> = <span class="ruby-constant">REJECT_WITH_RATINGS_UNDER</span>)
130:       <span class="ruby-identifier">not_by_country</span> = <span class="ruby-identifier">country_code</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">empty?</span>
131:       <span class="ruby-identifier">ratings</span> = {}
132:       <span class="ruby-identifier">wins</span> = {}
133:       <span class="ruby-identifier">percents</span> = {}
134:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">not_by_country</span>
135:         <span class="ruby-identifier">ratings</span> = <span class="ruby-identifier">ratings_overall</span>(<span class="ruby-identifier">question</span>)
136:         <span class="ruby-identifier">wins</span> = <span class="ruby-identifier">wins_overall</span>(<span class="ruby-identifier">question</span>)
137:         <span class="ruby-identifier">percents</span> = <span class="ruby-identifier">wins</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">|</span>
138:           <span class="ruby-identifier">rating</span> = <span class="ruby-identifier">ratings</span>[<span class="ruby-identifier">key</span>]
139:           <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">rating</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-value">100.0</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">wins</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">/</span> <span class="ruby-identifier">rating</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
140:           <span class="ruby-identifier">hash</span>
141:         <span class="ruby-keyword kw">end</span>
142:       <span class="ruby-keyword kw">else</span>
143:         <span class="ruby-identifier">group</span> = <span class="ruby-constant">Group</span>.<span class="ruby-identifier">first</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;groups.code LIKE '#{country_code}'&quot;</span>)
144:         <span class="ruby-identifier">result</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(
145:           <span class="ruby-node">&quot;SELECT item_id, ratings, wins, losses FROM stats WHERE question_id=#{question.id} AND group_id=#{group.id};&quot;</span>
146:         )
147:         <span class="ruby-identifier">stat</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">fetch_hash</span>
148:         <span class="ruby-keyword kw">begin</span>
149:           <span class="ruby-identifier">item_id</span> = <span class="ruby-identifier">stat</span>[<span class="ruby-value str">'item_id'</span>].<span class="ruby-identifier">to_i</span>
150:           <span class="ruby-identifier">ratings</span>[<span class="ruby-identifier">item_id</span>] = <span class="ruby-identifier">stat</span>[<span class="ruby-value str">'ratings'</span>].<span class="ruby-identifier">to_i</span>
151:           <span class="ruby-identifier">wins</span>[<span class="ruby-identifier">item_id</span>] = <span class="ruby-identifier">win</span> = <span class="ruby-identifier">stat</span>[<span class="ruby-value str">'wins'</span>].<span class="ruby-identifier">to_i</span>
152:           <span class="ruby-identifier">percents</span>[<span class="ruby-identifier">item_id</span>] = [<span class="ruby-identifier">win</span>, <span class="ruby-identifier">stat</span>[<span class="ruby-value str">'losses'</span>].<span class="ruby-identifier">to_i</span>].<span class="ruby-identifier">to_percent</span>
153:           <span class="ruby-identifier">stat</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">fetch_hash</span>
154:         <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stat</span>.<span class="ruby-identifier">nil?</span>
155:         <span class="ruby-identifier">result</span>.<span class="ruby-identifier">free</span>
156:       <span class="ruby-keyword kw">end</span>
157:       <span class="ruby-identifier">pos</span> = <span class="ruby-value">0</span>
158:       <span class="ruby-identifier">ranks</span> = <span class="ruby-identifier">percents</span>.<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">percent</span><span class="ruby-operator">|</span>
159:         [<span class="ruby-operator">-</span><span class="ruby-identifier">percent</span>.<span class="ruby-identifier">last</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">wins</span>[<span class="ruby-identifier">percent</span>.<span class="ruby-identifier">first</span>]]
160:       <span class="ruby-keyword kw">end</span>
161:       <span class="ruby-identifier">ranks</span> = <span class="ruby-identifier">ranks</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">percent</span><span class="ruby-operator">|</span>
162:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">percent</span>.<span class="ruby-identifier">first</span>] = <span class="ruby-identifier">pos</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
163:         <span class="ruby-identifier">hash</span>
164:       <span class="ruby-keyword kw">end</span>
165:       [<span class="ruby-identifier">wins</span>, <span class="ruby-identifier">ratings</span>, <span class="ruby-identifier">percents</span>, <span class="ruby-identifier">ranks</span>]
166:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000154" class="method-detail">
        <a name="M000154"></a>

        <div class="method-heading">
          <a href="#M000154" class="method-signature">
          <span class="method-name">new_remote</span><span class="method-args">(item, attachment, questions, visit_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000154-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000154-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 184</span>
184:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new_remote</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">attachment</span>, <span class="ruby-identifier">questions</span>, <span class="ruby-identifier">visit_id</span>)
185:       <span class="ruby-identifier">ext_id</span> = <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">item</span>(<span class="ruby-identifier">item</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">||</span> <span class="ruby-constant">DEFAULT_ITEM_NAME</span>, <span class="ruby-identifier">questions</span>)
186:       <span class="ruby-identifier">item</span>.<span class="ruby-identifier">item_id_ext</span> = <span class="ruby-identifier">ext_id</span>.<span class="ruby-identifier">first</span>
187:       <span class="ruby-identifier">item</span>.<span class="ruby-identifier">visit_id</span> = <span class="ruby-identifier">visit_id</span>
188:       <span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">save</span>
189:       <span class="ruby-identifier">item</span>.<span class="ruby-identifier">attachment_id</span> = <span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">id</span>
190:       <span class="ruby-identifier">item</span>.<span class="ruby-identifier">save</span>
191:       <span class="ruby-identifier">item</span>.<span class="ruby-identifier">questions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">questions</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">q</span><span class="ruby-operator">|</span> <span class="ruby-constant">Question</span>.<span class="ruby-identifier">find_by_question_id_ext</span>(<span class="ruby-identifier">q</span>) }
192:       <span class="ruby-identifier">item</span>
193:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000150" class="method-detail">
        <a name="M000150"></a>

        <div class="method-heading">
          <a href="#M000150" class="method-signature">
          <span class="method-name">page_find</span><span class="method-args">(page = 1)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000150-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000150-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 125</span>
125:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">page_find</span>(<span class="ruby-identifier">page</span> = <span class="ruby-value">1</span>)
126:       <span class="ruby-identifier">paginate</span>(<span class="ruby-identifier">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">page</span> <span class="ruby-operator">||</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:flags</span>, <span class="ruby-identifier">:questions</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;items.created_at desc, flags.active desc&quot;</span>)
127:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000163" class="method-detail">
        <a name="M000163"></a>

        <div class="method-heading">
          <a href="#M000163" class="method-signature">
          <span class="method-name">pairwise_rank</span><span class="method-args">(question)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000163-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000163-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 306</span>
306:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pairwise_rank</span>(<span class="ruby-identifier">question</span>)
307:       <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">list</span>(<span class="ruby-identifier">:item</span>, <span class="ruby-identifier">question</span>.<span class="ruby-identifier">question_id_ext</span>, <span class="ruby-constant">RANK_ALGO_ID</span>)
308:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000149" class="method-detail">
        <a name="M000149"></a>

        <div class="method-heading">
          <a href="#M000149" class="method-signature">
          <span class="method-name">per_page</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000149-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000149-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 123</span>
123:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">per_page</span>; <span class="ruby-constant">PER_PAGE</span> <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000158" class="method-detail">
        <a name="M000158"></a>

        <div class="method-heading">
          <a href="#M000158" class="method-signature">
          <span class="method-name">ratings_for_country</span><span class="method-args">(question, country = nil, with_skips = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000158-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000158-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 213</span>
213:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ratings_for_country</span>(<span class="ruby-identifier">question</span>, <span class="ruby-identifier">country</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">with_skips</span> = <span class="ruby-keyword kw">false</span>)
214:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN prompts ON (prompts.id=responses.prompt_id AND prompts.question_id=#{question.id}) INNER JOIN items_prompts ON (items_prompts.prompt_id=prompts.id)&quot;</span>
215:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN items_responses ON items_responses.response_id=responses.id #{joins}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">with_skips</span>
216:       <span class="ruby-identifier">conditions</span> = { <span class="ruby-value str">'responses.active'</span><span class="ruby-value str">'responses.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }
217:       <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'responses.ip_country_code'</span><span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">country</span>
218:       <span class="ruby-identifier">ratings</span> = <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
219:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">id</span>] = <span class="ruby-value">0</span>
220:         <span class="ruby-identifier">hash</span>
221:       <span class="ruby-keyword kw">end</span>
222:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">response</span> <span class="ruby-keyword kw">in</span> <span class="ruby-constant">Response</span>.<span class="ruby-identifier">all</span>({
223:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;COUNT(*) AS ratings, items_prompts.item_id AS id&quot;</span>,
224:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>,
225:         <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>,
226:         <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'items_prompts.item_id'</span>
227:       }) <span class="ruby-keyword kw">do</span>
228:         <span class="ruby-identifier">ratings</span>[<span class="ruby-identifier">response</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">ratings</span>.<span class="ruby-identifier">to_i</span>
229:       <span class="ruby-keyword kw">end</span>
230:       <span class="ruby-identifier">ratings</span>
231:     <span class="ruby-keyword kw">end</span>
232: 
233:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins_overall</span>(<span class="ruby-identifier">question</span>)
234:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span> }, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, wins'</span>).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
235:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">wins</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
236:         <span class="ruby-identifier">hash</span>
237:       <span class="ruby-keyword kw">end</span>
238:     <span class="ruby-keyword kw">end</span>
239: 
240:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins_for_country</span>(<span class="ruby-identifier">question</span>, <span class="ruby-identifier">country</span> = <span class="ruby-keyword kw">nil</span>)
241:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN items_responses ON (items_responses.response_id=responses.id) INNER JOIN prompts ON (responses.prompt_id=prompts.id AND prompts.question_id=#{question.id})&quot;</span>
242:       <span class="ruby-identifier">conditions</span> = {
243:         <span class="ruby-value str">'items_responses.item_id'</span><span class="ruby-value str">'items_responses.item_id'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span>,
244:         <span class="ruby-value str">'responses.active'</span><span class="ruby-value str">'responses.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
245:       }
246:       <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'responses.ip_country_code'</span><span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">country</span>
247:       <span class="ruby-identifier">wins</span> = <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
248:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">id</span>] = <span class="ruby-value">0</span>
249:         <span class="ruby-identifier">hash</span>
250:       <span class="ruby-keyword kw">end</span>
251:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">response</span> <span class="ruby-keyword kw">in</span> <span class="ruby-constant">Response</span>.<span class="ruby-identifier">all</span>({
252:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;COUNT(*) AS wins, items_responses.item_id AS id&quot;</span>,
253:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>,
254:         <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>,
255:         <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'items_responses.item_id'</span>
256:       }) <span class="ruby-keyword kw">do</span>
257:         <span class="ruby-identifier">wins</span>[<span class="ruby-identifier">response</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">wins</span>.<span class="ruby-identifier">to_i</span>
258:         <span class="ruby-identifier">wins</span>
259:       <span class="ruby-keyword kw">end</span>
260:       <span class="ruby-identifier">wins</span>
261:     <span class="ruby-keyword kw">end</span>
262: 
263:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall_array</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
264:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
265:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
266:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'(100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>,
267:         <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id'</span>
268:       ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> }
269:     <span class="ruby-keyword kw">end</span>
270: 
271:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
272:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
273:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
274:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, (100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>
275:       ).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
276:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
277:         <span class="ruby-identifier">hash</span>
278:       <span class="ruby-keyword kw">end</span>
279:     <span class="ruby-keyword kw">end</span>
280: 
281:     <span class="ruby-comment cmt"># def win_percents_for_country(question, country)</span>
282:     <span class="ruby-comment cmt">#   wins = wins_for_country(question)</span>
283:     <span class="ruby-comment cmt">#   ratings = ratings_for_country(question)</span>
284:     <span class="ruby-comment cmt">#   question.items.inject({}) do |hash, item|</span>
285:     <span class="ruby-comment cmt">#     rating = ratings[item.id]</span>
286:     <span class="ruby-comment cmt">#     hash[item.id] = rating != 0 ? 100 * (wins[item.id].to_f / rating) : 0</span>
287:     <span class="ruby-comment cmt">#     hash</span>
288:     <span class="ruby-comment cmt">#   end</span>
289:     <span class="ruby-comment cmt"># end</span>
290:     <span class="ruby-comment cmt"># </span>
291:     <span class="ruby-comment cmt"># # in tests batching further than this causes inefficient joins</span>
292:     <span class="ruby-comment cmt"># def win_percents_for_countries(question_id, items, countries, overall = false)</span>
293:     <span class="ruby-comment cmt">#   percents = items.to_a.inject({}) do |hash, item|</span>
294:     <span class="ruby-comment cmt">#     hash[item] = countries.map { |country| item.win_percent_for_country(country, question_id) }</span>
295:     <span class="ruby-comment cmt">#     hash</span>
296:     <span class="ruby-comment cmt">#   end</span>
297:     <span class="ruby-comment cmt">#   if overall</span>
298:     <span class="ruby-comment cmt">#     overall = win_percents_overall(question_id, items)</span>
299:     <span class="ruby-comment cmt">#     percents.each { |key, value| percents[key] = value.unshift(overall[key.id]) }</span>
300:     <span class="ruby-comment cmt">#   else</span>
301:     <span class="ruby-comment cmt">#     percents</span>
302:     <span class="ruby-comment cmt">#   end</span>
303:     <span class="ruby-comment cmt"># end</span>
304: 
305: <span class="ruby-identifier">private</span>
306:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pairwise_rank</span>(<span class="ruby-identifier">question</span>)
307:       <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">list</span>(<span class="ruby-identifier">:item</span>, <span class="ruby-identifier">question</span>.<span class="ruby-identifier">question_id_ext</span>, <span class="ruby-constant">RANK_ALGO_ID</span>)
308:     <span class="ruby-keyword kw">end</span>
309:   <span class="ruby-keyword kw">end</span>
310: 
311: <span class="ruby-identifier">private</span>
312:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_item_state</span>(<span class="ruby-identifier">state</span>)
313:     <span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:active</span>, <span class="ruby-identifier">state</span>)
314:     <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">update_item_state</span>(<span class="ruby-identifier">item_id_ext</span>, <span class="ruby-identifier">state</span>)
315:   <span class="ruby-keyword kw">end</span>
316: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000157" class="method-detail">
        <a name="M000157"></a>

        <div class="method-heading">
          <a href="#M000157" class="method-signature">
          <span class="method-name">ratings_overall</span><span class="method-args">(question)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000157-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000157-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 206</span>
206:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ratings_overall</span>(<span class="ruby-identifier">question</span>)
207:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span> }, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, (wins + losses) as ratings'</span>).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
208:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">ratings</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
209:         <span class="ruby-identifier">hash</span>
210:       <span class="ruby-keyword kw">end</span>
211:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000152" class="method-detail">
        <a name="M000152"></a>

        <div class="method-heading">
          <a href="#M000152" class="method-signature">
          <span class="method-name">refresh_rank</span><span class="method-args">(question)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
if nil <a href="Item.html#M000145">position</a> or unaccounted response,
refresh from pairwise
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000152-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000152-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 169</span>
169:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">refresh_rank</span>(<span class="ruby-identifier">question</span>)
170:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">refresh_rank?</span>(<span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>)
171:           <span class="ruby-identifier">ids_ext_to_rank</span> = (<span class="ruby-identifier">pairwise_rank</span>(<span class="ruby-identifier">question</span>) <span class="ruby-operator">||</span> <span class="ruby-keyword kw">return</span>).<span class="ruby-identifier">to_hash</span>
172:           <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value str">'items_questions.question_id'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value str">'items.item_id_ext'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ids_ext_to_rank</span>.<span class="ruby-identifier">keys</span>, <span class="ruby-value str">'items.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:item</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">iq</span><span class="ruby-operator">|</span>
173:             <span class="ruby-identifier">iq</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:position</span>, <span class="ruby-identifier">ids_ext_to_rank</span>[<span class="ruby-identifier">iq</span>.<span class="ruby-identifier">item</span>.<span class="ruby-identifier">item_id_ext</span>.<span class="ruby-identifier">to_i</span>])
174:           <span class="ruby-keyword kw">end</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ids_ext_to_rank</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
175:           <span class="ruby-constant">Response</span>.<span class="ruby-identifier">update_last_response</span>(<span class="ruby-constant">LAST_RANK_RESPONSE</span>, <span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>)
176:       <span class="ruby-keyword kw">end</span>
177:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000155" class="method-detail">
        <a name="M000155"></a>

        <div class="method-heading">
          <a href="#M000155" class="method-signature">
          <span class="method-name">refresh_rank?</span><span class="method-args">(question_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000155-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000155-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 195</span>
195:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">refresh_rank?</span>(<span class="ruby-identifier">question_id</span>)
196:       <span class="ruby-identifier">count</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:active</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;INNER JOIN items_questions ON (question_id=#{question_id.to_i} AND item_id=items.id AND position IS NULL)&quot;</span>) <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Constants</span><span class="ruby-operator">::</span><span class="ruby-constant">Responses</span><span class="ruby-operator">::</span><span class="ruby-constant">UntilRank</span><span class="ruby-operator">::</span><span class="ruby-constant">ITEMS</span>  <span class="ruby-operator">||</span> <span class="ruby-constant">Response</span>.<span class="ruby-identifier">refresh_response?</span>(<span class="ruby-constant">LAST_RANK_RESPONSE</span>, <span class="ruby-identifier">question_id</span>)
197:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000164" class="method-detail">
        <a name="M000164"></a>

        <div class="method-heading">
          <a href="#M000164" class="method-signature">
          <span class="method-name">update_item_state</span><span class="method-args">(state)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000164-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000164-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 312</span>
312:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_item_state</span>(<span class="ruby-identifier">state</span>)
313:     <span class="ruby-identifier">update_attribute</span>(<span class="ruby-identifier">:active</span>, <span class="ruby-identifier">state</span>)
314:     <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">update_item_state</span>(<span class="ruby-identifier">item_id_ext</span>, <span class="ruby-identifier">state</span>)
315:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000153" class="method-detail">
        <a name="M000153"></a>

        <div class="method-heading">
          <a href="#M000153" class="method-signature">
          <span class="method-name">valid_objects</span><span class="method-args">(item, attachment, questions)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000153-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000153-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 179</span>
179:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">valid_objects</span>(<span class="ruby-identifier">item</span>, <span class="ruby-identifier">attachment</span>, <span class="ruby-identifier">questions</span>)
180:       <span class="ruby-comment cmt"># so validation is always run on item and attachment</span>
181:       (<span class="ruby-identifier">item</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">valid?</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">questions</span>.<span class="ruby-identifier">empty?</span>
182:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000162" class="method-detail">
        <a name="M000162"></a>

        <div class="method-heading">
          <a href="#M000162" class="method-signature">
          <span class="method-name">win_percents_overall</span><span class="method-args">(question_id, item_ids)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000162-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000162-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 271</span>
271:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
272:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
273:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
274:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, (100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>
275:       ).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
276:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
277:         <span class="ruby-identifier">hash</span>
278:       <span class="ruby-keyword kw">end</span>
279:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000161" class="method-detail">
        <a name="M000161"></a>

        <div class="method-heading">
          <a href="#M000161" class="method-signature">
          <span class="method-name">win_percents_overall_array</span><span class="method-args">(question_id, item_ids)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000161-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000161-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 263</span>
263:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall_array</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
264:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
265:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
266:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'(100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>,
267:         <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id'</span>
268:       ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> }
269:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000160" class="method-detail">
        <a name="M000160"></a>

        <div class="method-heading">
          <a href="#M000160" class="method-signature">
          <span class="method-name">wins_for_country</span><span class="method-args">(question, country = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000160-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000160-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 240</span>
240:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins_for_country</span>(<span class="ruby-identifier">question</span>, <span class="ruby-identifier">country</span> = <span class="ruby-keyword kw">nil</span>)
241:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN items_responses ON (items_responses.response_id=responses.id) INNER JOIN prompts ON (responses.prompt_id=prompts.id AND prompts.question_id=#{question.id})&quot;</span>
242:       <span class="ruby-identifier">conditions</span> = {
243:         <span class="ruby-value str">'items_responses.item_id'</span><span class="ruby-value str">'items_responses.item_id'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span>,
244:         <span class="ruby-value str">'responses.active'</span><span class="ruby-value str">'responses.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
245:       }
246:       <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-value str">'responses.ip_country_code'</span><span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">country</span>
247:       <span class="ruby-identifier">wins</span> = <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span>.<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
248:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">id</span>] = <span class="ruby-value">0</span>
249:         <span class="ruby-identifier">hash</span>
250:       <span class="ruby-keyword kw">end</span>
251:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">response</span> <span class="ruby-keyword kw">in</span> <span class="ruby-constant">Response</span>.<span class="ruby-identifier">all</span>({
252:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;COUNT(*) AS wins, items_responses.item_id AS id&quot;</span>,
253:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>,
254:         <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>,
255:         <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'items_responses.item_id'</span>
256:       }) <span class="ruby-keyword kw">do</span>
257:         <span class="ruby-identifier">wins</span>[<span class="ruby-identifier">response</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">wins</span>.<span class="ruby-identifier">to_i</span>
258:         <span class="ruby-identifier">wins</span>
259:       <span class="ruby-keyword kw">end</span>
260:       <span class="ruby-identifier">wins</span>
261:     <span class="ruby-keyword kw">end</span>
262: 
263:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall_array</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
264:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
265:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
266:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'(100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>,
267:         <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id'</span>
268:       ).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span> <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> }
269:     <span class="ruby-keyword kw">end</span>
270: 
271:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percents_overall</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">item_ids</span>)
272:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(
273:         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">item_ids</span> },
274:         <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, (100*CONVERT(wins, DECIMAL(13,10))/(wins + losses)) AS win_percent'</span>
275:       ).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
276:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>.<span class="ruby-identifier">to_i</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
277:         <span class="ruby-identifier">hash</span>
278:       <span class="ruby-keyword kw">end</span>
279:     <span class="ruby-keyword kw">end</span>
280: 
281:     <span class="ruby-comment cmt"># def win_percents_for_country(question, country)</span>
282:     <span class="ruby-comment cmt">#   wins = wins_for_country(question)</span>
283:     <span class="ruby-comment cmt">#   ratings = ratings_for_country(question)</span>
284:     <span class="ruby-comment cmt">#   question.items.inject({}) do |hash, item|</span>
285:     <span class="ruby-comment cmt">#     rating = ratings[item.id]</span>
286:     <span class="ruby-comment cmt">#     hash[item.id] = rating != 0 ? 100 * (wins[item.id].to_f / rating) : 0</span>
287:     <span class="ruby-comment cmt">#     hash</span>
288:     <span class="ruby-comment cmt">#   end</span>
289:     <span class="ruby-comment cmt"># end</span>
290:     <span class="ruby-comment cmt"># </span>
291:     <span class="ruby-comment cmt"># # in tests batching further than this causes inefficient joins</span>
292:     <span class="ruby-comment cmt"># def win_percents_for_countries(question_id, items, countries, overall = false)</span>
293:     <span class="ruby-comment cmt">#   percents = items.to_a.inject({}) do |hash, item|</span>
294:     <span class="ruby-comment cmt">#     hash[item] = countries.map { |country| item.win_percent_for_country(country, question_id) }</span>
295:     <span class="ruby-comment cmt">#     hash</span>
296:     <span class="ruby-comment cmt">#   end</span>
297:     <span class="ruby-comment cmt">#   if overall</span>
298:     <span class="ruby-comment cmt">#     overall = win_percents_overall(question_id, items)</span>
299:     <span class="ruby-comment cmt">#     percents.each { |key, value| percents[key] = value.unshift(overall[key.id]) }</span>
300:     <span class="ruby-comment cmt">#   else</span>
301:     <span class="ruby-comment cmt">#     percents</span>
302:     <span class="ruby-comment cmt">#   end</span>
303:     <span class="ruby-comment cmt"># end</span>
304: 
305: <span class="ruby-identifier">private</span>
306:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pairwise_rank</span>(<span class="ruby-identifier">question</span>)
307:       <span class="ruby-constant">Pairwise</span>.<span class="ruby-identifier">list</span>(<span class="ruby-identifier">:item</span>, <span class="ruby-identifier">question</span>.<span class="ruby-identifier">question_id_ext</span>, <span class="ruby-constant">RANK_ALGO_ID</span>)
308:     <span class="ruby-keyword kw">end</span>
309:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000159" class="method-detail">
        <a name="M000159"></a>

        <div class="method-heading">
          <a href="#M000159" class="method-signature">
          <span class="method-name">wins_overall</span><span class="method-args">(question)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000159-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000159-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 233</span>
233:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins_overall</span>(<span class="ruby-identifier">question</span>)
234:       <span class="ruby-constant">ItemsQuestion</span>.<span class="ruby-identifier">all</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:item_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question</span>.<span class="ruby-identifier">item_ids</span> }, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'item_id, wins'</span>).<span class="ruby-identifier">inject</span>({}) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hash</span>, <span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
235:         <span class="ruby-identifier">hash</span>[<span class="ruby-identifier">el</span>.<span class="ruby-identifier">item_id</span>] = <span class="ruby-identifier">el</span>.<span class="ruby-identifier">wins</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
236:         <span class="ruby-identifier">hash</span>
237:       <span class="ruby-keyword kw">end</span>
238:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000147" class="method-detail">
        <a name="M000147"></a>

        <div class="method-heading">
          <a href="#M000147" class="method-signature">
          <span class="method-name">activate</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000147-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000147-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 93</span>
93:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">activate</span>
94:     <span class="ruby-comment cmt"># only allow activation of items with attachments</span>
95:     <span class="ruby-identifier">update_item_state</span>(<span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">nil?</span>
96:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000148" class="method-detail">
        <a name="M000148"></a>

        <div class="method-heading">
          <a href="#M000148" class="method-signature">
          <span class="method-name">plot</span><span class="method-args">(for_questions = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000148-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000148-source">
<pre>
     <span class="ruby-comment cmt"># File app/models/item.rb, line 98</span>
 98:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">plot</span>(<span class="ruby-identifier">for_questions</span> = <span class="ruby-keyword kw">nil</span>)
 99: <span class="ruby-comment cmt">#    groups = Group.all(:select =&gt; 'code, name')</span>
100: <span class="ruby-comment cmt">#    countries = groups.map(&amp;:code)</span>
101: <span class="ruby-comment cmt">#    country_names = groups.map(&amp;:name)</span>
102: <span class="ruby-comment cmt">#    (for_questions || questions).each do |question|</span>
103: <span class="ruby-comment cmt">#      graph = Scruffy::Graph.new</span>
104: <span class="ruby-comment cmt">#      graph.title = question.name.strip_tags</span>
105: <span class="ruby-comment cmt">#      graph.renderer = Scruffy::Renderers::Standard.new</span>
106: <span class="ruby-comment cmt">#      percents = countries.map { |country| win_percent_for_country(country, question.id).to_i }</span>
107: <span class="ruby-comment cmt">#      percents.unshift(win_percent(question.id))</span>
108: <span class="ruby-comment cmt">#      graph.add :bar, 'percent wins', percents</span>
109: <span class="ruby-comment cmt">#      graph.render(</span>
110: <span class="ruby-comment cmt">#        :min_value =&gt; 0,</span>
111: <span class="ruby-comment cmt">#        :max_value =&gt; 100,</span>
112: <span class="ruby-comment cmt">#        :size =&gt; [520, 300],</span>
113: <span class="ruby-comment cmt">#        :to =&gt; &quot;#{Constants::Config::Paths::PLOTS}question_#{question.id}_item_#{id}.png&quot;,</span>
114: <span class="ruby-comment cmt">#        :as =&gt; 'png',</span>
115: <span class="ruby-comment cmt">#        :point_markers =&gt; ['', 'All', '', 'China', '', 'Japan', '', 'US', '']</span>
116: <span class="ruby-comment cmt">#      )</span>
117: <span class="ruby-comment cmt">#    end</span>
118:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000145" class="method-detail">
        <a name="M000145"></a>

        <div class="method-heading">
          <a href="#M000145" class="method-signature">
          <span class="method-name">position</span><span class="method-args">(question_id = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000145-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000145-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 84</span>
84:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">position</span>(<span class="ruby-identifier">question_id</span> = <span class="ruby-keyword kw">nil</span>)
85:     (<span class="ruby-identifier">question_id</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">items_questions</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">find_all_by_question_id</span>(<span class="ruby-identifier">question_id</span>)).<span class="ruby-identifier">avg</span>(<span class="ruby-identifier">:position</span>)
86:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000138" class="method-detail">
        <a name="M000138"></a>

        <div class="method-heading">
          <a href="#M000138" class="method-signature">
          <span class="method-name">question</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000138-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000138-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 25</span>
25:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">question</span>
26:     <span class="ruby-identifier">questions</span>.<span class="ruby-identifier">first</span>
27:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000139" class="method-detail">
        <a name="M000139"></a>

        <div class="method-heading">
          <a href="#M000139" class="method-signature">
          <span class="method-name">ratings</span><span class="method-args">(question_id, with_skips = false, joins = nil, conditions = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000139-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000139-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 29</span>
29:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ratings</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">with_skips</span> = <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">joins</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">conditions</span> = {})
30:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">with_skips</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">joins</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">empty?</span>
31:       <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">find_by_question_id</span>(<span class="ruby-identifier">question_id</span>).<span class="ruby-identifier">ratings</span>
32:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">joins</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">empty?</span>
33:       <span class="ruby-identifier">iq</span> = <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">find_by_question_id</span>(<span class="ruby-identifier">question_id</span>)
34:       <span class="ruby-identifier">iq</span>.<span class="ruby-identifier">wins</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">iq</span>.<span class="ruby-identifier">losses</span>
35:     <span class="ruby-keyword kw">else</span>
36:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN prompts ON prompts.id=responses.prompt_id INNER JOIN items_prompts ON (items_prompts.prompt_id=prompts.id AND items_prompts.item_id=#{id}) #{joins}&quot;</span>
37:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN items_responses ON items_responses.response_id=responses.id #{joins}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">with_skips</span>
38:       <span class="ruby-constant">Response</span>.<span class="ruby-identifier">count</span>(<span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> {
39:         <span class="ruby-value str">'prompts.question_id'</span><span class="ruby-value str">'prompts.question_id'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span>,
40:         <span class="ruby-value str">'responses.active'</span><span class="ruby-value str">'responses.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
41:       }.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">conditions</span>))
42:     <span class="ruby-keyword kw">end</span>
43:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000140" class="method-detail">
        <a name="M000140"></a>

        <div class="method-heading">
          <a href="#M000140" class="method-signature">
          <span class="method-name">ratings_for_country</span><span class="method-args">(country_code, question_id, with_skips = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000140-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000140-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 45</span>
45:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ratings_for_country</span>(<span class="ruby-identifier">country_code</span>, <span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">with_skips</span> = <span class="ruby-keyword kw">true</span>)
46:     <span class="ruby-identifier">ratings</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">with_skips</span>, <span class="ruby-keyword kw">nil</span>, { <span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country_code</span> })
47:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000146" class="method-detail">
        <a name="M000146"></a>

        <div class="method-heading">
          <a href="#M000146" class="method-signature">
          <span class="method-name">suspend</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000146-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000146-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 88</span>
88:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">suspend</span>
89:     <span class="ruby-identifier">update_item_state</span>(<span class="ruby-keyword kw">false</span>)
90:     <span class="ruby-constant">Prompt</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-value str">&quot;active=0&quot;</span>, <span class="ruby-node">&quot;prompts.active=1 AND prompts.id IN (#{self.prompt_ids.join(',')})&quot;</span>)
91:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000143" class="method-detail">
        <a name="M000143"></a>

        <div class="method-heading">
          <a href="#M000143" class="method-signature">
          <span class="method-name">win_percent</span><span class="method-args">(question_id = nil, with_skips = false, joins = nil, conditions = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000143-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000143-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 62</span>
62:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percent</span>(<span class="ruby-identifier">question_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">with_skips</span> = <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">joins</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">conditions</span> = {})
63:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">question_id</span>
64:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">joins</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">empty?</span>
65:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">with_skips</span>
66:           <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">first</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span> }, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'100*(wins/ratings) AS win_percent'</span>).<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span>
67:         <span class="ruby-keyword kw">else</span>
68:           <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">first</span>(<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:question_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">question_id</span> }, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'100*(wins/(wins+losses)) AS win_percent'</span>).<span class="ruby-identifier">win_percent</span>.<span class="ruby-identifier">to_f</span>
69:         <span class="ruby-keyword kw">end</span>
70:       <span class="ruby-keyword kw">else</span>
71:         <span class="ruby-identifier">ratings</span> = <span class="ruby-identifier">ratings</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">with_skips</span>, <span class="ruby-identifier">joins</span>, <span class="ruby-identifier">conditions</span>)
72:         <span class="ruby-identifier">ratings</span>.<span class="ruby-identifier">zero?</span> <span class="ruby-value">? </span><span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-value">100</span> <span class="ruby-operator">*</span> (<span class="ruby-identifier">wins</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">joins</span>, <span class="ruby-identifier">conditions</span>) <span class="ruby-operator">/</span> <span class="ruby-identifier">ratings</span>.<span class="ruby-identifier">to_f</span>)
73:       <span class="ruby-keyword kw">end</span>
74:     <span class="ruby-keyword kw">else</span>
75:       <span class="ruby-comment cmt"># for all questions</span>
76:       <span class="ruby-identifier">questions</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">q</span><span class="ruby-operator">|</span> <span class="ruby-identifier">win_percent</span>(<span class="ruby-identifier">q</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">with_skips</span>, <span class="ruby-identifier">joins</span>) }.<span class="ruby-identifier">avg</span>
77:     <span class="ruby-keyword kw">end</span>
78:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000144" class="method-detail">
        <a name="M000144"></a>

        <div class="method-heading">
          <a href="#M000144" class="method-signature">
          <span class="method-name">win_percent_for_country</span><span class="method-args">(country_code, question_id = nil, with_skips = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000144-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000144-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 80</span>
80:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">win_percent_for_country</span>(<span class="ruby-identifier">country_code</span>, <span class="ruby-identifier">question_id</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">with_skips</span> = <span class="ruby-keyword kw">false</span>)
81:     <span class="ruby-identifier">win_percent</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">with_skips</span>, <span class="ruby-keyword kw">nil</span>, { <span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country_code</span> })
82:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000142" class="method-detail">
        <a name="M000142"></a>

        <div class="method-heading">
          <a href="#M000142" class="method-signature">
          <span class="method-name">wins</span><span class="method-args">(question_id, joins = nil, conditions = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000142-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000142-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 53</span>
53:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-identifier">joins</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">conditions</span> = {})
54:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">joins</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">empty?</span>
55:       <span class="ruby-identifier">items_questions</span>.<span class="ruby-identifier">find_by_question_id</span>(<span class="ruby-identifier">question_id</span>).<span class="ruby-identifier">wins</span>
56:     <span class="ruby-keyword kw">else</span>
57:       <span class="ruby-identifier">joins</span> = <span class="ruby-node">&quot;INNER JOIN items_responses ON (items_responses.response_id=responses.id AND items_responses.item_id=#{id}) INNER JOIN prompts ON (responses.prompt_id=prompts.id AND prompts.question_id=#{question_id}) #{joins}&quot;</span>
58:       <span class="ruby-constant">Response</span>.<span class="ruby-identifier">count</span>(<span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">joins</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value str">'responses.active'</span><span class="ruby-value str">'responses.active'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">conditions</span>))
59:     <span class="ruby-keyword kw">end</span>
60:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000141" class="method-detail">
        <a name="M000141"></a>

        <div class="method-heading">
          <a href="#M000141" class="method-signature">
          <span class="method-name">wins_for_country</span><span class="method-args">(country_code, question_id)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000141-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000141-source">
<pre>
    <span class="ruby-comment cmt"># File app/models/item.rb, line 49</span>
49:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wins_for_country</span>(<span class="ruby-identifier">country_code</span>, <span class="ruby-identifier">question_id</span>)
50:     <span class="ruby-identifier">wins</span>(<span class="ruby-identifier">question_id</span>, <span class="ruby-keyword kw">nil</span>, { <span class="ruby-value str">'responses.ip_country_code'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">country_code</span> })
51:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>